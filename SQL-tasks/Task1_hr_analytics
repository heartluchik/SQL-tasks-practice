

/* Employees whose salary is higher than their direct manager's salary */
SELECT
    e.employee_id,
    e.name,
    e.salary,
    e.chief_id,
    chief.salary AS chief_salary
FROM employee e
JOIN employee chief
  ON e.chief_id = chief.employee_id
WHERE e.salary > chief.salary;


/* Employees with the maximum salary in their department
      - RANK() handles ties: if two people share the top salary, both appear */
SELECT
    employee_id,
    name,
    department_id,
    salary
FROM (
    SELECT
        e.employee_id,
        e.name,
        e.department_id,
        e.salary,
        RANK() OVER (
            PARTITION BY e.department_id
            ORDER BY e.salary DESC
        ) AS salary_rank
    FROM employee e
)
WHERE salary_rank = 1;


/* Departments where more than 3 employees earn above the company average salary */
SELECT
    d.department_id,
    d.name,
    COUNT(*) AS high_earners_count
FROM department d
JOIN employee e
  ON d.department_id = e.department_id
WHERE e.salary > (SELECT AVG(salary) FROM employee)
GROUP BY d.department_id, d.name
HAVING COUNT(*) > 3
ORDER BY high_earners_count DESC;


/* Employees whose manager is NOT in the same department */
SELECT
    e.employee_id,
    e.name,
    e.department_id,
    e.chief_id,
    chief.department_id AS chief_department_id
FROM employee e
JOIN employee chief
  ON e.chief_id = chief.employee_id
WHERE e.department_id != chief.department_id;


/* Department(s) with the maximum total salary (sum of employee salaries)
      - Uses RANK() so ties are included */
SELECT
    department_id,
    name,
    total_salary
FROM (
    SELECT
        d.department_id,
        d.name,
        SUM(e.salary) AS total_salary,
        RANK() OVER (
            ORDER BY SUM(e.salary) DESC
        ) AS total_salary_rank
    FROM department d
    JOIN employee e
      ON d.department_id = e.department_id
    GROUP BY d.department_id, d.name
)
WHERE total_salary_rank = 1;


/* Employees whose salary is higher than the salary of the top-most manager
      in their hierarchy (Oracle hierarchical query: CONNECT BY)

      Idea:
      - Build a hierarchy for each employee (CONNECT_BY_ROOT)
      - Identify the top-most manager salary for that employee
      - Compare employee salary to that top-most manager salary */
SELECT
    e.employee_id,
    e.name,
    e.salary,
    h.top_chief_salary,
    h.top_chief_id
FROM employee e
JOIN (
    SELECT
        CONNECT_BY_ROOT employee_id AS emp_id,

        /* Salary of the top-most manager in the chain for this employee */
        MAX(salary) KEEP (DENSE_RANK LAST ORDER BY LEVEL) AS top_chief_salary,

        /* ID of the top-most manager in the chain for this employee */
        MAX(employee_id) KEEP (DENSE_RANK LAST ORDER BY LEVEL) AS top_chief_id
    FROM employee
    START WITH chief_id IS NOT NULL
    CONNECT BY PRIOR chief_id = employee_id
    GROUP BY CONNECT_BY_ROOT employee_id
) h
  ON e.employee_id = h.emp_id
WHERE e.salary > h.top_chief_salary
  AND e.employee_id != h.top_chief_id;
